name: Handle PyPI Publish triggers

# output_object="{\"name\": \"$name\", \"version\": \"$version\", \"archive_url\": \"$archive_url\"}"
on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Name of the package'
        required: true
        default: 'pypi-package'
      version:
        description: 'Version of the package'
        required: true
        default: '0.0.1'
      archive_url:
        description: 'URL to the archive of the package'
        required: true
        default: ''

jobs:
    publish:
        runs-on: ubuntu-latest
        
        # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
        permissions:
          pages: write      # to deploy to Pages
          id-token: write   # to verify the deployment originates from an appropriate source

        # Deploy to the github-pages environment
        environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}

        steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: 3.12

        - name: upsert-package
          env:
            python_service_name: "${{ inputs.name }}"
            python_service_version: "${{ inputs.version }}"
            python_service_archive_url: "${{ inputs.archive_url }}"
            root_dir: "pypi"
            base_url: "https://bitovi.github.io/PyPI"
          run: python src/main.py

        - name: commit changes
          run: |
            echo "configure git"
            git config user.email "github-actions-triggers-allowed[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
  
            echo "git status - before"
            git status

            git checkout -b "pypi-${{ github.run_id }}"
            
            echo "git add pypi/."
            git add pypi/.
    
            # tmp file for commit message
            commit_message_file="$(mktemp)"
            echo "PyPI Package Upsert" > "${commit_message_file}"
            echo "{ \"name\": \"${{ inputs.name }}\", \"version\": \"${{ inputs.version }}\", \"archive_url\": \"${{ inputs.archive_url }}\" }" >> "${commit_message_file}"

            commit_message="$(cat ${commit_message_file})"

            echo "commit message:"
            echo "${commit_message}"
    
            git commit -m "${commit_message}"
    
            echo "git status - after"
            git status
    
    
            echo "git log"
            git log -n 3
    
            echo "git push"
            git push -u origin HEAD